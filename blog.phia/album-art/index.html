<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My #Fav Album Art | Blog.phia</title>
    <link href="../../style.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="../../favicon.png" />
</head>
<body>
    <div class="preload-images"></div>

    <div class="blogpage">
        
        <div class="navbar">
            <a class="swl" href="https://sophiawliu.com/">Sophia Liu</a>
            <ul class="menu">
                <li class="active"><a href="../">BLOG</a></li>
                <li><a href="../../work/">WORK</a></li>
            </ul>
        </div>

        <div class="blogstuff">

            <div class="backcontainer">
                <a href="../" class="backpointer">‚òú</a><a class="back" href="../"> Back to blog index</a>
            </div>

            <div class="blog-heading">
                <p class="blog-title">My #Fav Album Art</p>
                <p class="blog-desc">Collected in <a class="borzoitest" href="https://open.spotify.com/playlist/7HbYoNgiASpm3OIVmxBtg8?si=c2d7148c611a4c3f" target="_blank">this playlist</a> üß∫, automatically populated here.</p>
                <p class="blog-date">Created September 14th, 2025 ~ 4ever ‚ôæÔ∏è</p>
            </div>
            <p class="blog-body">Songs with album art so spectacular, I find myself listening to them again and again just to look at their covers. It's a combo experience, audio-visual.</p>
            <p class="blog-body">Sometimes I judge a song by its cover... art. Sue me.</p>
            
            <p class="blog-body">The design of this website was actually inspired by this album cover:</p>

            <div class="castaways-display">
                <div class="castaways-album-cover">
                    <img src="https://i.scdn.co/image/ab67616d0000b2734c68627b39b807870c5d2fbd" alt="Liar, Liar by The Castaways">
                </div>
                <div class="castaways-album-info">
                    <div class="castaways-song-title">Goodbye Babe</div>
                    <div class="castaways-artist-name">The Castaways</div>
                    <a class="castaways-play-link" href="https://open.spotify.com/track/3aUh3EXm5aRTF52B26ZqQY" target="_blank">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"></path>
                        </svg>
                        Play on Spotify
                    </a>
                    <div class="castaways-added-date">Added: 3/28/2024</div>
                </div>
            </div>

            <p class="blog-body">I'm still looking for a font that's a combination of <span class="peralta">Peralta</span> and <span class="swungnote-font">Swungnote</span>. I can't decide which one I like more.</p>

              <div class="collection-info" style="text-align: center;">
                 <p class="blog-body"><strong>collection started:</strong><br>December 11, 2023 <span id="collection-age"></span></p>
                 <p class="blog-body"><strong>last updated:</strong><br><span id="last-updated">loading...</span></p>
                 <p class="blog-body"><strong># of albums collected:</strong><br><span id="album-count">loading...</span></p>
              </div><br>

            <!-- Controls -->
            <div class="controls-container">
                <!-- Sort dropdown -->
                <div class="sort-container">
                    <label for="sort-select" class="sort-label"><strong>sort by:</strong></label>
                    <select id="sort-select" class="sort-dropdown">
                        <option value="date-added">date added (newest first)</option>
                        <option value="date-added-oldest">date added (oldest first)</option>
                        <option value="color">üåà COLOR ü™Ñ</option>
                        <option value="album-date">album release date (newest first)</option>
                        <option value="album-date-oldest">album release date (oldest first)</option>
                        <option value="album-title">album title (a-z)</option>
                        <option value="artist-name">artist name (a-z)</option>
                    </select>
                </div>

                <!-- Display options -->
                <div class="display-container">
                    <label class="display-label"><strong>display:</strong></label>
                    <div class="display-options">
                        <button id="display-small" class="display-btn" data-size="small">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="2" y="2" width="4" height="4"/>
                                <rect x="8" y="2" width="4" height="4"/>
                                <rect x="14" y="2" width="4" height="4"/>
                                <rect x="20" y="2" width="2" height="4"/>
                                <rect x="2" y="8" width="4" height="4"/>
                                <rect x="8" y="8" width="4" height="4"/>
                                <rect x="14" y="8" width="4" height="4"/>
                                <rect x="20" y="8" width="2" height="4"/>
                                <rect x="2" y="14" width="4" height="4"/>
                                <rect x="8" y="14" width="4" height="4"/>
                                <rect x="14" y="14" width="4" height="4"/>
                                <rect x="20" y="14" width="2" height="4"/>
                                <rect x="2" y="20" width="4" height="2"/>
                                <rect x="8" y="20" width="4" height="2"/>
                                <rect x="14" y="20" width="4" height="2"/>
                                <rect x="20" y="20" width="2" height="2"/>
                            </svg>
                            small
                        </button>
                        <button id="display-medium" class="display-btn active" data-size="medium">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                            </svg>
                            medium
                        </button>
                        <button id="display-large" class="display-btn" data-size="large">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="3" y="3" width="18" height="18"/>
                            </svg>
                            large
                        </button>
                    </div>
                </div>
            </div><br>

            <!-- Loading state -->
            <div id="loading" class="loading-container">
                <div class="spinner"></div>
                <p class="blog-body">loading... give it a sec</p>
            </div>

            <!-- Album grid container -->
            <div id="album-grid" class="album-grid" style="display: none;">
                <!-- Album covers will be dynamically inserted here -->
            </div><br>

            <!-- Expanded album modal -->
            <div id="album-modal" class="album-modal" style="display: none;">
                <div class="modal-overlay"></div>
                <div class="modal-content">
                    <div class="modal-album-cover">
                        <img id="modal-album-image" src="" alt="">
                    </div>
                    <div class="modal-album-info">
                        <div class="modal-song-title"></div>
                        <div class="modal-artist-name"></div>
                        <a class="modal-play-link" href="" target="_blank">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                            </svg>
                            Play on Spotify
                        </a>
                        <div class="modal-added-date"></div>
                    </div>
                </div>
            </div>

            <!-- Error state -->
            <div id="error" class="error-container" style="display: none;">
                <p class="blog-body">Unable to load album art. Please try again later.</p>
            </div>

            <div class="backcontainer">
                <a href="../" class="backpointer">‚òú</a><a class="back" href="../"> Back to blog index</a>
            </div>
        </div>

        <div class="footer">
            <div class="contact">
                <a href="mailto: sophiawliu@berkeley.edu" target="_blank">
                    <svg class="contact-icon" viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1920 428.266v1189.54l-464.16-580.146-88.203 70.585 468.679 585.904H83.684l468.679-585.904-88.202-70.585L0 1617.805V428.265l959.944 832.441L1920 428.266ZM1919.932 226v52.627l-959.943 832.44L.045 278.628V226h1919.887Z" fill-rule="evenodd"/>
                    </svg>
                </a>
                <a href="https://www.linkedin.com/in/sophiawliu/" target="_blank">
                    <svg class="contact-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                </a>
                <a href="https://scholar.google.com/citations?user=I1vWa1UAAAAJ&hl=en" target="_blank">
                    <svg class="contact-icon" viewBox="8.098918399999999 46.912 369.65785600000004 418.814976" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 343.75868,106.66243 V 79.430205 L 363.52365,63.999997 H 149.63354 L 20.476345,176.2736 h 85.656075 c -0.15534,2.12494 -0.21914,4.04644 -0.21914,6.22563 0,20.84472 7.2192,38.08662 21.67203,51.86089 14.45284,13.79702 32.25124,20.64784 53.32651,20.64784 4.92319,0 9.75059,-0.36794 14.43842,-1.02419 -2.90722,6.50082 -4.37457,12.52302 -4.37457,18.14228 0,9.87526 4.49924,20.4304 13.46715,31.6418 -39.23377,2.6705 -68.06112,9.73264 -86.43702,21.16322 -10.53108,6.49907 -19.000207,14.70396 -25.390349,24.5311 -6.390569,9.89933 -9.577754,20.51525 -9.577754,31.9616 0,9.64822 2.062375,18.33611 6.21907,26.06233 4.156694,7.7263 9.577757,14.07047 16.312223,18.98408 6.71825,4.96781 14.46899,9.10088 23.219,12.46874 8.73429,3.34378 17.40643,5.71858 26.06106,7.06258 8.62707,1.34222 17.20471,1.9985 25.70579,1.9985 13.46887,0 26.95353,-1.73428 40.54711,-5.18707 13.56165,-3.48461 26.28022,-8.64143 38.17105,-15.4927 11.85935,-6.80488 21.51545,-16.0865 28.9219,-27.7183 7.39024,-11.67998 11.09457,-24.80499 11.09457,-39.33613 0,-11.01584 -2.24964,-21.03852 -6.7502,-30.14073 -4.46864,-9.07202 -9.93785,-16.54102 -16.45271,-22.34403 -6.5008,-5.81263 -12.99987,-11.15539 -19.51512,-15.9679 -6.50083,-4.84488 -12.00021,-9.75058 -16.46884,-14.8129 -4.4848,-5.04657 -6.73444,-10.05419 -6.73444,-14.98395 0,-4.92145 1.73422,-9.67183 5.21588,-14.26559 3.45451,-4.6095 7.67376,-9.04795 12.60967,-13.30571 4.93756,-4.24944 9.87523,-8.96788 14.79665,-14.13302 4.92147,-5.14719 9.14072,-11.82739 12.60971,-20.00822 3.48467,-8.17907 5.20318,-17.44489 5.20318,-27.75679 0,-13.4527 -2.54714,-24.46065 -7.54735,-33.31348 -0.59369,-1.02243 -1.21757,-1.80338 -1.87511,-3.02225 l 56.90745,-46.672136 v 17.118526 c -7.39373,0.92969 -6.62422,5.34582 -6.62422,10.6352 v 128.66719 c 0,5.95832 4.8751,10.83382 10.83386,10.83382 h 3.98869 c 5.95835,0 10.83386,-4.87506 10.83386,-10.83382 V 117.29282 c 0,-5.27669 0.77741,-9.68801 -6.56167,-10.63039 z M 236.39865,329.14114 c 1.14099,0.7503 3.7039,2.78075 7.7184,6.03838 4.0495,3.24319 6.797,5.69582 8.26567,7.41432 1.43851,1.66381 3.5792,4.16501 6.37617,7.54734 2.81268,3.3744 4.7184,6.30394 5.71853,8.73425 1.00016,2.4767 2.01603,5.46089 3.04636,8.94556 0.98567,3.44488 1.48486,6.97595 1.48486,10.56169 0,17.04813 -6.56338,29.68007 -19.65604,37.85915 -13.125,8.18083 -28.76651,12.27368 -46.93767,12.27368 -9.18709,0 -18.2031,-1.09289 -27.06247,-3.1951 -8.84322,-2.11665 -17.31192,-5.3362 -25.39035,-9.60185 -8.07846,-4.25771 -14.57754,-10.20337 -19.50072,-17.79659 -4.93764,-7.64012 -7.40645,-16.41464 -7.40645,-26.24962 0,-10.32022 2.79692,-19.28987 8.42233,-26.90588 5.59343,-7.62564 12.93774,-13.3919 22.03208,-17.3154 9.0624,-3.94582 18.24946,-6.74232 27.56166,-8.39827 9.31221,-1.7023 18.79679,-2.555 28.43842,-2.555 4.46862,0 7.93582,0.25115 10.40465,0.69607 0.45456,0.21918 3.03188,2.07025 7.73456,5.56326 4.70401,3.46237 7.62565,5.59519 8.75047,6.38401 z m -3.35823,-100.5779 c -7.40648,8.85938 -17.73454,13.2882 -30.95363,13.2882 -11.85933,0 -22.29766,-4.76482 -31.26554,-14.31195 -8.99984,-9.52309 -15.42235,-20.32803 -19.34408,-32.43061 -3.93752,-12.10871 -5.90585,-23.98423 -5.90585,-35.648 0,-13.6942 3.59542,-25.35184 10.7809,-34.97598 7.18727,-9.64952 17.49915,-14.48477 30.93786,-14.48477 11.87507,0 22.37423,5.03825 31.43704,15.15677 9.09434,10.08482 15.60961,21.41303 19.5169,33.96799 3.92176,12.5392 5.87345,24.52979 5.87345,35.98399 0,13.44658 -3.70256,24.60984 -11.07663,33.45436 z" style="stroke-width:0.0647871"/>
                    </svg>
                </a>
                <a href="https://github.com/sophiawliu" target="_blank">
                    <svg class="contact-icon" viewBox="0 0 98 96" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"/>
                    </svg>
                </a>
                <a href="https://x.com/tweet_phia" target="_blank">
                    <svg class="contact-icon" viewBox="0 0 1200 1227" xmlns="http://www.w3.org/2000/svg">
                        <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/>
                    </svg>
                </a>
                <a href="https://open.spotify.com/user/uniponpeg?si=3d2258ef77b74a61" target="_blank">
                    <svg class="contact-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Spotify Web API configuration
        const SPOTIFY_CLIENT_ID = '63ac9cc70ce147b3a9486fa6477416c0';
        const SPOTIFY_CLIENT_SECRET = 'e4eb93ba58a444158f6506eb03e1b52f';
        const PLAYLIST_ID = '7HbYoNgiASpm3OIVmxBtg8';
        
        let accessToken = null;
        let allTracks = []; // Store all tracks for sorting
        let currentDisplaySize = 'medium'; // Default display size

        // Get access token using Client Credentials flow
        async function getAccessToken() {
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET)
                },
                body: 'grant_type=client_credentials'
            });
            
            const data = await response.json();
            return data.access_token;
        }

        // Fetch playlist tracks (all tracks, not just first 100)
        async function fetchPlaylistTracks() {
            try {
                if (!accessToken) {
                    accessToken = await getAccessToken();
                }

                let allTracks = [];
                let nextUrl = `https://api.spotify.com/v1/playlists/${PLAYLIST_ID}/tracks?limit=50`;
                
                // Fetch all tracks (Spotify API returns max 100 per request, so we paginate)
                while (nextUrl) {
                    const response = await fetch(nextUrl, {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch playlist');
                    }

                    const data = await response.json();
                    allTracks = allTracks.concat(data.items);
                    nextUrl = data.next; // Continue to next page if exists
                }

                // Sort tracks by added_at date (most recent first)
                allTracks.sort((a, b) => new Date(b.added_at) - new Date(a.added_at));
                
                // Return tracks with most recent first
                return allTracks;
            } catch (error) {
                console.error('Error fetching playlist:', error);
                throw error;
            }
        }

        // Create album cover element
        function createAlbumCover(track) {
            const album = track.track.album;
            const song = track.track;
            const albumCover = document.createElement('div');
            albumCover.className = 'album-cover';
            
            const img = document.createElement('img');
            img.src = album.images[0].url; // Use the largest image
            img.alt = `${album.name} by ${album.artists[0].name}`;
            img.loading = 'lazy';
            
            // Create popup with song info
            const popup = document.createElement('div');
            popup.className = 'album-popup';
            
            const songTitle = document.createElement('div');
            songTitle.className = 'song-title';
            songTitle.textContent = song.name;
            
            const artistName = document.createElement('div');
            artistName.className = 'artist-name';
            artistName.textContent = song.artists.map(artist => artist.name).join(', ');
            
            const addedDate = document.createElement('div');
            addedDate.className = 'added-date';
            const addedAt = new Date(track.added_at);
            addedDate.textContent = `Added: ${addedAt.toLocaleDateString()}`;
            
            popup.appendChild(songTitle);
            popup.appendChild(artistName);
            popup.appendChild(addedDate);
            
            // Add click handler to open modal
            albumCover.addEventListener('click', () => {
                openAlbumModal(track);
            });
            
            albumCover.appendChild(img);
            albumCover.appendChild(popup);
            return albumCover;
        }

        // Sort tracks based on selected option
        async function sortTracks(tracks, sortBy) {
            const validTracks = tracks.filter(track => track.track && track.track.album);
            
            switch (sortBy) {
                case 'date-added':
                    return validTracks.sort((a, b) => new Date(b.added_at) - new Date(a.added_at));
                case 'date-added-oldest':
                    return validTracks.sort((a, b) => new Date(a.added_at) - new Date(b.added_at));
                case 'album-date':
                    return validTracks.sort((a, b) => new Date(b.track.album.release_date) - new Date(a.track.album.release_date));
                case 'album-date-oldest':
                    return validTracks.sort((a, b) => new Date(a.track.album.release_date) - new Date(b.track.album.release_date));
                case 'album-title':
                    return validTracks.sort((a, b) => a.track.album.name.localeCompare(b.track.album.name));
                case 'artist-name':
                    return validTracks.sort((a, b) => a.track.artists[0].name.localeCompare(b.track.artists[0].name));
                case 'color':
                    // Sort by color - analyze all images first
                    const tracksWithColors = await Promise.all(
                        validTracks.map(async (track) => {
                            const imageUrl = track.track.album.images[0]?.url;
                            if (!imageUrl) return { track, color: { h: 0, s: 0, l: 0.5 } };
                            
                            const color = await getDominantColor(imageUrl);
                            return { track, color };
                        })
                    );
                    
                    // Sort by color with black/grey/white at the end
                    return tracksWithColors
                        .sort((a, b) => {
                            // Check if colors are achromatic (black, grey, white)
                            const aIsAchromatic = a.color.s < 0.1 || a.color.l < 0.1 || a.color.l > 0.9;
                            const bIsAchromatic = b.color.s < 0.1 || b.color.l < 0.1 || b.color.l > 0.9;
                            
                            // If one is achromatic and the other isn't, put achromatic at the end
                            if (aIsAchromatic && !bIsAchromatic) return 1;
                            if (!aIsAchromatic && bIsAchromatic) return -1;
                            
                            // If both are achromatic, sort by lightness (dark to light)
                            if (aIsAchromatic && bIsAchromatic) {
                                return a.color.l - b.color.l;
                            }
                            
                            // If both are chromatic, sort by hue (rainbow order: red -> orange -> yellow -> green -> blue -> purple)
                            return a.color.h - b.color.h;
                        })
                        .map(item => item.track);
                default:
                    return validTracks;
            }
        }

        // Color analysis and caching
        const colorCache = new Map();

        // Extract dominant color from an image
        function getDominantColor(imageUrl) {
            return new Promise((resolve) => {
                if (colorCache.has(imageUrl)) {
                    resolve(colorCache.get(imageUrl));
                    return;
                }

                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Use smaller canvas for performance
                    canvas.width = 50;
                    canvas.height = 50;
                    
                    ctx.drawImage(img, 0, 0, 50, 50);
                    const imageData = ctx.getImageData(0, 0, 50, 50);
                    const data = imageData.data;
                    
                    // Sample pixels and find dominant color
                    const colorCounts = {};
                    for (let i = 0; i < data.length; i += 16) { // Sample every 4th pixel
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // Skip very dark or very light pixels
                        const brightness = (r + g + b) / 3;
                        if (brightness < 30 || brightness > 225) continue;
                        
                        // Quantize colors to reduce noise
                        const quantizedR = Math.round(r / 32) * 32;
                        const quantizedG = Math.round(g / 32) * 32;
                        const quantizedB = Math.round(b / 32) * 32;
                        
                        const colorKey = `${quantizedR},${quantizedG},${quantizedB}`;
                        colorCounts[colorKey] = (colorCounts[colorKey] || 0) + 1;
                    }
                    
                    // Find most common color
                    let maxCount = 0;
                    let dominantColor = { r: 0, g: 0, b: 0 };
                    
                    for (const [colorKey, count] of Object.entries(colorCounts)) {
                        if (count > maxCount) {
                            maxCount = count;
                            const [r, g, b] = colorKey.split(',').map(Number);
                            dominantColor = { r, g, b };
                        }
                    }
                    
                    // Convert to HSL for better sorting
                    const hsl = rgbToHsl(dominantColor.r, dominantColor.g, dominantColor.b);
                    colorCache.set(imageUrl, hsl);
                    resolve(hsl);
                };
                
                img.onerror = () => {
                    // Fallback to neutral color if image fails to load
                    const fallback = { h: 0, s: 0, l: 0.5 };
                    colorCache.set(imageUrl, fallback);
                    resolve(fallback);
                };
                
                img.src = imageUrl;
            });
        }

        // Convert RGB to HSL
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // achromatic
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            
            return { h: h * 360, s, l };
        }

        // Display album covers in grid
        async function displayAlbumCovers(tracks, sortBy = 'date-added', displaySize = 'small') {
            const grid = document.getElementById('album-grid');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            
            // Show loading for color sorting
            if (sortBy === 'color') {
                loading.style.display = 'block';
                loading.innerHTML = '<div class="spinner"></div><p class="blog-body">loading... give it a sec ü¶Ñ</p>';
                grid.style.display = 'none';
                error.style.display = 'none';
            } else {
                // Hide loading and error states for other sorts
                loading.style.display = 'none';
                error.style.display = 'none';
            }
            
            // Clear existing content
            grid.innerHTML = '';
            
            // Remove existing size classes
            grid.classList.remove('small', 'medium', 'large');
            
            // Add new size class
            grid.classList.add(displaySize);
            
            // Sort tracks based on selected option
            const sortedTracks = await sortTracks(tracks, sortBy);
            
            // Create album covers
            sortedTracks.forEach(track => {
                const albumCover = createAlbumCover(track);
                grid.appendChild(albumCover);
            });
            
            // Show the grid and hide loading
            grid.style.display = 'grid';
            loading.style.display = 'none';
            
            // Update last updated date and show track count
            const lastUpdated = document.getElementById('last-updated');
            const albumCount = document.getElementById('album-count');
            const collectionAge = document.getElementById('collection-age');
            
            // Find the actual most recent date from all tracks (not sorted)
            if (allTracks.length > 0) {
                const allDates = allTracks.map(track => new Date(track.added_at));
                const mostRecentDate = new Date(Math.max(...allDates));
                const daysAgo = Math.floor((new Date() - mostRecentDate) / (1000 * 60 * 60 * 24));
                lastUpdated.textContent = `${mostRecentDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })} (${daysAgo} days ago)`;
            }
            
            // Calculate collection age
            const collectionStartDate = new Date('2023-12-11');
            const today = new Date();
            const totalDays = Math.floor((today - collectionStartDate) / (1000 * 60 * 60 * 24));
            const years = Math.floor(totalDays / 365);
            const remainingDays = totalDays % 365;
            
            if (years > 0) {
                collectionAge.textContent = `(${years} year${years > 1 ? 's' : ''} and ${remainingDays} day${remainingDays !== 1 ? 's' : ''} old)`;
            } else {
                collectionAge.textContent = `(${remainingDays} day${remainingDays !== 1 ? 's' : ''} old)`;
            }
            
            albumCount.textContent = `${allTracks.length} albums`;
            
            console.log(`Displayed ${sortedTracks.length} album covers, sorted by ${sortBy}, size: ${displaySize}`);
        }

        // Open album modal
        function openAlbumModal(track) {
            const modal = document.getElementById('album-modal');
            const album = track.track.album;
            const song = track.track;
            
            // Populate modal content
            document.getElementById('modal-album-image').src = album.images[0].url;
            document.getElementById('modal-album-image').alt = `${album.name} by ${album.artists[0].name}`;
            document.querySelector('.modal-song-title').textContent = song.name;
            document.querySelector('.modal-artist-name').textContent = song.artists.map(artist => artist.name).join(', ');
            document.querySelector('.modal-play-link').href = song.external_urls.spotify;
            document.querySelector('.modal-added-date').textContent = `Added: ${new Date(track.added_at).toLocaleDateString()}`;
            
            // Show modal
            modal.style.display = 'flex';
        }

        // Close album modal
        function closeAlbumModal() {
            const modal = document.getElementById('album-modal');
            modal.style.display = 'none';
        }

        // Handle errors
        function handleError() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const grid = document.getElementById('album-grid');
            
            loading.style.display = 'none';
            grid.style.display = 'none';
            error.style.display = 'block';
        }

        // Initialize the page
        async function init() {
            try {
                allTracks = await fetchPlaylistTracks();
                await displayAlbumCovers(allTracks, 'date-added', currentDisplaySize);
                
                // Add event listener for sort dropdown
                const sortSelect = document.getElementById('sort-select');
                sortSelect.addEventListener('change', async (e) => {
                    // Toggle rainbow background for color sorting
                    if (e.target.value === 'color') {
                        e.target.classList.add('rainbow-bg');
                        // Set display size to small for color sorting (best for rainbow effect)
                        currentDisplaySize = 'small';
                        // Update display buttons to reflect small selection
                        document.querySelectorAll('.display-btn').forEach(btn => btn.classList.remove('active'));
                        document.getElementById('display-small').classList.add('active');
                    } else {
                        e.target.classList.remove('rainbow-bg');
                    }
                    
                    await displayAlbumCovers(allTracks, e.target.value, currentDisplaySize);
                });
                
                // Add event listeners for display buttons
                const displayButtons = document.querySelectorAll('.display-btn');
                displayButtons.forEach(button => {
                    button.addEventListener('click', async (e) => {
                        // Remove active class from all buttons
                        displayButtons.forEach(btn => btn.classList.remove('active'));
                        
                        // Add active class to clicked button
                        e.target.classList.add('active');
                        
                        // Update current display size
                        currentDisplaySize = e.target.dataset.size;
                        
                        // Re-display with new size
                        await displayAlbumCovers(allTracks, sortSelect.value, currentDisplaySize);
                    });
                });
                
                // Add event listeners for modal
                const modal = document.getElementById('album-modal');
                const overlay = document.querySelector('.modal-overlay');
                
                overlay.addEventListener('click', closeAlbumModal);
                
                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.style.display === 'flex') {
                        closeAlbumModal();
                    }
                });
            } catch (error) {
                handleError();
            }
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>